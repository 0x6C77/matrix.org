#!/bin/bash -eux

# update_docs.sh: regenerates the autogenerated files on the matrix.org site.
# At present this includes:
#   * the spec index, intro and appendices
#   * the guides and howtos
#
# It does *not* include the client-server API, which is generated by
# other scripts in this directory and then *committed to git*.

# Note that this file is world-readable unless someone plays some .htaccess hijinks

echo >&2 "Make sure you have run \`git submodule update --remote\` to pull in the latest changes."

SELF="${BASH_SOURCE[0]}"
if [[ "${SELF}" != /* ]]; then
  SELF="$(pwd)/${SELF}"
fi
SELF="${SELF/\/.\///}"
cd "$(dirname "$(dirname "${SELF}")")"

SITE_BASE="$(pwd)"
INCLUDES="${SITE_BASE}/includes/from_jekyll"

# figure out the most recent version of the C-S API
CS_VER=$(perl -ne 'if(/topic-title.*Version: (r\d+\.\d+.\d+)/) {print "$1\n"}' \
            docs/spec/client_server/latest.html)

if [ -z "$CS_VER" ]; then
    echo >&2 "Unable to find version number in client-server spec"
    exit 1
fi

(
cd matrix-doc/scripts
rm -r gen
python gendoc.py -c $CS_VER

# don't overwrite the existing C-S spec
rm -r gen/client_server

find gen -name '*.html' | xargs ./add-matrix-org-stylings.pl "${INCLUDES}"
)

mkdir -p docs/howtos
mv matrix-doc/scripts/gen/howtos.html docs/howtos/client-server.html
cp -r matrix-doc/scripts/gen/* docs/spec


./jekyll/generate.sh

echo "generating docs/spec/olm.html"
rst2html.py olm/docs/olm.rst > docs/spec/olm.html
